<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8">
<title>C++/C语言学习 - JUSTME</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />



    <meta name="description" content="Effective c++item1 把c++看成语言的集合C++可以看成由几个模块组成：  C：C++是以C为基础的，指针、数组、数据类型等都是来自于C OOC（Object-Oriented C++）：类、继承、多态、虚函数等 Template：泛型模块 STL  这样区分的目的是：不同的模块有不同的编程策略  C模块中，一般用值传递 OOC，常量引用传递 STL，也是使用值传递  ite">
<meta property="og:type" content="article">
<meta property="og:title" content="C++&#x2F;C语言学习">
<meta property="og:url" content="http://yoursite.com/2021/11/24/C-C%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="JUSTME">
<meta property="og:description" content="Effective c++item1 把c++看成语言的集合C++可以看成由几个模块组成：  C：C++是以C为基础的，指针、数组、数据类型等都是来自于C OOC（Object-Oriented C++）：类、继承、多态、虚函数等 Template：泛型模块 STL  这样区分的目的是：不同的模块有不同的编程策略  C模块中，一般用值传递 OOC，常量引用传递 STL，也是使用值传递  ite">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/images/og_image.png">
<meta property="article:published_time" content="2021-11-24T07:25:09.000Z">
<meta property="article:modified_time" content="2023-05-18T08:34:48.967Z">
<meta property="article:author" content="JUSTME">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/images/og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/monokai-sublime.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
<meta name="generator" content="Hexo 5.4.2"></head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="C++/C语言学习" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">主页</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/categories">分类</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-11-24T07:25:09.000Z">2021-11-24</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    23 分钟 读完 (大约 3394 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-medium">
            
                C++/C语言学习
            
        </h1>
        <div class="content">
            <html><head></head><body><span id="more"></span>

<h2 id="Effective-c"><a href="#Effective-c" class="headerlink" title="Effective c++"></a>Effective c++</h2><h3 id="item1-把c-看成语言的集合"><a href="#item1-把c-看成语言的集合" class="headerlink" title="item1 把c++看成语言的集合"></a>item1 把c++看成语言的集合</h3><p>C++可以看成由几个模块组成：</p>
<ul>
<li>C：C++是以C为基础的，指针、数组、数据类型等都是来自于C</li>
<li>OOC（Object-Oriented C++）：类、继承、多态、虚函数等</li>
<li>Template：泛型模块</li>
<li>STL</li>
</ul>
<p>这样区分的目的是：不同的模块有不同的编程策略</p>
<ul>
<li>C模块中，一般用值传递</li>
<li>OOC，常量引用传递</li>
<li>STL，也是使用值传递</li>
</ul>
<h3 id="item2-用const、enum、inline代替-define"><a href="#item2-用const、enum、inline代替-define" class="headerlink" title="item2 用const、enum、inline代替#define"></a>item2 用const、enum、inline代替#define</h3><p>尽量以编译器代替预处理器</p>
<p>方便在编译出错的时候找到错误位置，因为编译器对变量报错是根据符号表来的，宏至少简单的文本替换，出错的时候不容易定位。</p>
<ul>
<li>用const用来声明数值常量、常量指针、类中的常量需要加上static，从而保证不会产生多个拷贝</li>
<li>enum hack：enum的行为像#define，比如不能获得地址，不会引来非必要的内存分配</li>
<li>使用inline代替宏：对于简单的语句封装成函数不划算，但是用宏可能会带来一些不可预料的错误，尽量写templet inline函数。</li>
</ul>
<h3 id="item3-多用const"><a href="#item3-多用const" class="headerlink" title="item3 多用const"></a>item3 多用const</h3><h4 id="const的使用范围"><a href="#const的使用范围" class="headerlink" title="const的使用范围"></a>const的使用范围</h4><ul>
<li>可以在class外部修饰global或namesspace作用域中的常量</li>
<li>可以修饰被声明为static的对象</li>
<li>也可以修饰class内部的static和non-static成员变量</li>
<li>指针自身，指针所指也可以是const</li>
</ul>
<h4 id="const的语法规则"><a href="#const的语法规则" class="headerlink" title="const的语法规则"></a>const的语法规则</h4><ul>
<li><code>const int* ptr</code>被指的是常量，也就是指向的内存不能修改</li>
<li><code>int* const ptr</code>指针本身是常量，指针指向的位置不能修改</li>
<li><code>const int* ptr</code>和<code>int const* ptr</code>，意义相同</li>
</ul>
<h4 id="STL迭代器的const"><a href="#STL迭代器的const" class="headerlink" title="STL迭代器的const"></a>STL迭代器的const</h4><ul>
<li>对于STL的迭代器，如果希望迭代器所指的东西不可变动，需要使用的是const_iterator,如<code>std::vector&lt;int&gt;::const_iterator const_itr = vec.begin()</code></li>
<li>如果迭代器本身不可变动，即不可指向别的地方，直接用const修饰即可</li>
</ul>
<h4 id="const在声明函数使用"><a href="#const在声明函数使用" class="headerlink" title="const在声明函数使用"></a>const在声明函数使用</h4><p>const可以修饰函数的返回值、函数参数、函数自身</p>
<p><code>const Rational operator* (const Rational&amp; lhs, const Rational&amp; rhs);</code></p>
<h4 id="const成员函数"><a href="#const成员函数" class="headerlink" title="const成员函数"></a>const成员函数</h4><p>指明该函数不会修改类的任何成员数据的值</p>
<h4 id="bitwise-constness和logical-constness"><a href="#bitwise-constness和logical-constness" class="headerlink" title="bitwise constness和logical constness"></a>bitwise constness和logical constness</h4><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">class</span> <span class="title class_">BigArray</span> {</span><br><span class="line">    vector&lt;<span class="hljs-type">int</span>&gt; v; </span><br><span class="line">    <span class="hljs-type">int</span> accessCounter;</span><br><span class="line"><span class="hljs-keyword">public</span>:</span><br><span class="line">    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">getItem</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> <span class="hljs-type">const</span> </span>{ </span><br><span class="line">        accessCounter++;</span><br><span class="line">        <span class="hljs-keyword">return</span> v[index];</span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>这个是编译不过的。我们希望的是getItem不会修改核心成员，而不考虑非核心成员，是logical constness。</p>
<p>编译器只认bitwise constness，为了解决这个问题，用mutable修饰accessCounter：<code>mutable int accessCounter;</code>。</p>
<h4 id="const和non-const成员函数的重复问题"><a href="#const和non-const成员函数的重复问题" class="headerlink" title="const和non-const成员函数的重复问题"></a>const和non-const成员函数的重复问题</h4><p>为了避免代码重复，使用non-const函数调用const函数。</p>
<h4 id="关于const约束的变量"><a href="#关于const约束的变量" class="headerlink" title="关于const约束的变量"></a>关于const约束的变量</h4><blockquote>
<p>从变量的名称开始，顺时针移动到下一个指针或者类型，直到表达式结束</p>
<p>或者是从右到左的语法解码，后面的修饰前面的</p>
</blockquote>
<p><img src="/2021/11/24/C-C%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/image-20211124152818134.png" alt="image-20211124152818134"></p>
<p><img src="/2021/11/24/C-C%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/image-20211124152837816.png" alt="image-20211124152837816"></p>
<p><code>*</code>读作<code>pointer to</code></p>
<ul>
<li><code>int const *p</code>：p是一个指针，指向一个const int，也就是说p本身指向的位置是可以修改的，但是指向的内存不能修改</li>
<li><code>int * const p</code>：p是一个const指针，指向int，就是说这个指针指向的位置不能修改，但是允许修改存储在地址的值</li>
<li><code>const int* cont p</code>：p是一个const 指针，指向一个const int。p既不能修改指向的位置，也不能修改里面的值</li>
</ul>
<p><img src="/2021/11/24/C-C%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/image-20211124153447661.png" alt="image-20211124153447661"></p>
<h3 id="item-4确定对象被使用之前已经被初始化"><a href="#item-4确定对象被使用之前已经被初始化" class="headerlink" title="item 4确定对象被使用之前已经被初始化"></a>item 4确定对象被使用之前已经被初始化</h3><h4 id="永远在对象使用之前初始化"><a href="#永远在对象使用之前初始化" class="headerlink" title="永远在对象使用之前初始化"></a>永远在对象使用之前初始化</h4><p>对于基本数据类型，手工完成。对于类，写构造函数，使得对象的每一个成员都被初始化。</p>
<p>主要：赋值和初始化不同</p>
<h4 id="赋值与初始化"><a href="#赋值与初始化" class="headerlink" title="赋值与初始化"></a>赋值与初始化</h4><h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><h3 id="虚函数"><a href="#虚函数" class="headerlink" title="虚函数"></a>虚函数</h3><p><a target="_blank" rel="noopener" href="http://www.noobyard.com/article/p-yfcqfueo-su.html">http://www.noobyard.com/article/p-yfcqfueo-su.html</a></p>
<p>为什么要有虚函数：为了实现动态绑定，即在运行时决定调用哪个函数。举个例子：person为基类，派生出student 和 teacher子类，现在学校大门口有一个队列，存放了一系列person指针，每次pop，通过ptr调用函数“出校”，区别是学生需要扫码，而教师不需要，但是编译器在编译程序的时候并不知道要调用哪个出校函数，这取决与运行时队列pop出来的到底是student还是teacher，也就是动态绑定的含义，通过对象的虚表指针调用，因此也可以理解为：虚函数是将函数绑定到特定类的一种手段。</p>
<p><img src="/2021/11/24/C-C%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/image-20211228120744580.png" alt="image-20211228120744580"></p>
<h3 id="static关键字"><a href="#static关键字" class="headerlink" title="static关键字"></a>static关键字</h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/37439983">https://zhuanlan.zhihu.com/p/37439983</a></p>
<p>static出现在两种场景：面向对象和面向过程</p>
<ul>
<li>面向对象    <ul>
<li>静态成员变量</li>
<li>静态成员函数</li>
</ul>
</li>
<li>面向过程<ul>
<li>静态全局变量</li>
<li>静态局部变量</li>
<li>静态函数</li>
</ul>
</li>
</ul>
<h4 id="静态成员变量"><a href="#静态成员变量" class="headerlink" title="静态成员变量"></a>静态成员变量</h4><p>为什么要用static成员变量？每个对象有用相同的某项属性，就用static，比如student类，包含static int num 学生总人数，这是每个学生实例公用的。</p>
<p>static成员变量分配在数据段</p>
<p>跟全局对象相比：静态成员变量的命名空间在类中，不会与全局命名空间的命名产生冲突。static可以加入访问控制，比如private。</p>
<h4 id="静态成员函数"><a href="#静态成员函数" class="headerlink" title="静态成员函数"></a>静态成员函数</h4><p>为什么用static成员函数？类似的，static成员函数为类服务，而不是为对象服务，因此static成员函数也没有this指针，因此也仅可以访问静态成员函数和静态成员变量</p>
<p>静态成员函数不能访问非静态成员函数和变量</p>
<p>反过来非静态成员函数可以任意访问静态成员函数和变量</p>
<h4 id="静态全局变量"><a href="#静态全局变量" class="headerlink" title="静态全局变量"></a>静态全局变量</h4><h4 id="静态局部变量"><a href="#静态局部变量" class="headerlink" title="静态局部变量"></a>静态局部变量</h4><h4 id="静态函数"><a href="#静态函数" class="headerlink" title="静态函数"></a>静态函数</h4><p>static函数仅在声明他的函数中可见，不能被其他文件使用</p>
<p>为什么用？不同文件中可以定义相同名字的函数，不会发生冲突。</p>
<h3 id="RAII"><a href="#RAII" class="headerlink" title="RAII"></a>RAII</h3><h2 id="modern-C"><a href="#modern-C" class="headerlink" title="modern C++"></a>modern C++</h2><h3 id="完美转发std-forward"><a href="#完美转发std-forward" class="headerlink" title="完美转发std::forward"></a>完美转发std::forward</h3><h3 id="RAII和智能指针"><a href="#RAII和智能指针" class="headerlink" title="RAII和智能指针"></a>RAII和智能指针</h3><h4 id="RAII-1"><a href="#RAII-1" class="headerlink" title="RAII"></a>RAII</h4><p>RAII是c++特有的资源管理方式。把依赖栈和析构函数，对所有资源进行管理（包括堆内存，下面有一个例子）。栈上的指针在释放的时候会调用析构函数，在析构函数里释放堆内存。</p>
<p>例子：</p>
<p>create_shape在堆上new了对象，返回对象的指针，如何让这块内存不会泄露？</p>
<p>把这个函数的返回值（对象的指针），包裹到一个局部对象中，该局部对象的析构函数中delete掉这个指针。</p>
<figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="hljs-keyword">class</span> <span class="title class_">shape_wrapper</span> {</span><br><span class="line"><span class="hljs-keyword">public</span>:</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">shape_wrapper</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-params"><span class="hljs-function">    shape* ptr = <span class="hljs-literal">nullptr</span>)</span></span></span><br><span class="line"><span class="hljs-function">    : ptr_(ptr) {</span>}</span><br><span class="line">  ~<span class="hljs-built_in">shape_wrapper</span>()</span><br><span class="line">  {</span><br><span class="line">    <span class="hljs-keyword">delete</span> ptr_;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function">shape* <span class="hljs-title">get</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> ptr_; }</span><br><span class="line"><span class="hljs-keyword">private</span>:</span><br><span class="line">  shape* ptr_;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  …</span><br><span class="line">  <span class="hljs-function">shape_wrapper <span class="hljs-title">ptr_wrapper</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-params"><span class="hljs-function">    create_shape(…))</span></span>;<span class="hljs-comment">//这里的shape_wrapper是一个局部栈对象，退出foo函数时会自动析构wrapper对象，而wrapper的析构函数会delete传入的shape指针。</span></span><br><span class="line">  …</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>经典RAII的例子：</p>
<figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">std::mutex mtx;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">some_func</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(mtx)</span></span>;</span><br><span class="line">  <span class="hljs-comment">// 做需要同步的工作</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>而不写成：</p>
<figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">std::mutex mtx;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">some_func</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  mtx.<span class="hljs-built_in">lock</span>();</span><br><span class="line">  <span class="hljs-comment">// 做需要同步的工作……</span></span><br><span class="line">  <span class="hljs-comment">// 如果发生异常或提前返回，</span></span><br><span class="line">  <span class="hljs-comment">// 下面这句不会自动执行。</span></span><br><span class="line">  mtx.<span class="hljs-built_in">unlock</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="智能指针实现"><a href="#智能指针实现" class="headerlink" title="智能指针实现"></a>智能指针实现</h4><p>从刚刚shape_wrapper类改造成模板类，就是一个简单的智能指针：</p>
<figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;</span><br><span class="line"><span class="hljs-keyword">class</span> <span class="title class_">smart_ptr</span> {</span><br><span class="line"><span class="hljs-keyword">public</span>:</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">smart_ptr</span><span class="hljs-params">(T* ptr = <span class="hljs-literal">nullptr</span>)</span></span></span><br><span class="line"><span class="hljs-function">    : ptr_(ptr) {</span>}</span><br><span class="line">  ~<span class="hljs-built_in">smart_ptr</span>()</span><br><span class="line">  {</span><br><span class="line">    <span class="hljs-keyword">delete</span> ptr_;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function">T* <span class="hljs-title">get</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> ptr_; }</span><br><span class="line"><span class="hljs-keyword">private</span>:</span><br><span class="line">  T* ptr_;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>但是这样跟指针的行为还有点差异，比如不能用*解引用，不能用-&gt;访问成员，不能用在bool表达式里，因此添加：</p>
<figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;</span><br><span class="line"><span class="hljs-keyword">class</span> <span class="title class_">smart_ptr</span> {</span><br><span class="line"><span class="hljs-keyword">public</span>:</span><br><span class="line">  …</span><br><span class="line">  T&amp; <span class="hljs-keyword">operator</span>*() <span class="hljs-type">const</span> { <span class="hljs-keyword">return</span> *ptr_; }</span><br><span class="line">  T* <span class="hljs-keyword">operator</span>-&gt;() <span class="hljs-type">const</span> { <span class="hljs-keyword">return</span> ptr_; }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">operator</span> <span class="hljs-title">bool</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> ptr_; }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后对于拷贝构造呢？<code>smart_ptr&lt;shape&gt; ptr2(ptr1)</code>应该怎么表现？</p>
<p>转移指针所有权，这就是auto_ptr的实现了，现在已经废除，因为这样设计的smart_ptr一旦进行了赋值或拷贝，就不在拥有这个对象了。</p>
<figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;</span><br><span class="line"><span class="hljs-keyword">class</span> <span class="title class_">smart_ptr</span> {</span><br><span class="line">  …</span><br><span class="line">  <span class="hljs-built_in">smart_ptr</span>(smart_ptr&amp; other) <span class="hljs-comment">//拷贝构造</span></span><br><span class="line">  {</span><br><span class="line">    ptr_ = other.<span class="hljs-built_in">release</span>();</span><br><span class="line">  }</span><br><span class="line">  smart_ptr&amp; <span class="hljs-keyword">operator</span>=(smart_ptr&amp; rhs) <span class="hljs-comment">//赋值</span></span><br><span class="line">  {</span><br><span class="line">    <span class="hljs-built_in">smart_ptr</span>(rhs).<span class="hljs-built_in">swap</span>(*<span class="hljs-keyword">this</span>);</span><br><span class="line">   	<span class="hljs-comment">//首先rhs把自己维护的指针交给给临时对象smart_ptr(rhs)，然后这个临时对象维护的指针和this对象维护的指针交换一下，this对象就拿到rhs维护的指针了，临时对象smart_ptr拿到this之前维护的指针，它会随着临时对象smart_ptr销毁而被delete。</span></span><br><span class="line">    <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;</span><br><span class="line">  }</span><br><span class="line">  …</span><br><span class="line">  <span class="hljs-function">T* <span class="hljs-title">release</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">  </span>{</span><br><span class="line">    T* ptr = ptr_;</span><br><span class="line">    ptr_ = <span class="hljs-literal">nullptr</span>;</span><br><span class="line">    <span class="hljs-keyword">return</span> ptr;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">swap</span><span class="hljs-params">(smart_ptr&amp; rhs)</span></span></span><br><span class="line"><span class="hljs-function">  </span>{</span><br><span class="line">    <span class="hljs-keyword">using</span> std::swap;</span><br><span class="line">    <span class="hljs-built_in">swap</span>(ptr_, rhs.ptr_);</span><br><span class="line">  }</span><br><span class="line">  …</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>再改下，就是unique_ptr：</p>
<figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;</span><br><span class="line"><span class="hljs-keyword">class</span> <span class="title class_">smart_ptr</span> {</span><br><span class="line">  …</span><br><span class="line">  <span class="hljs-built_in">smart_ptr</span>(smart_ptr&amp;&amp; other) <span class="hljs-comment">//改成移动构造函数</span></span><br><span class="line">  {</span><br><span class="line">    ptr_ = other.<span class="hljs-built_in">release</span>();</span><br><span class="line">  }</span><br><span class="line">  smart_ptr&amp; <span class="hljs-keyword">operator</span>=(smart_ptr rhs)</span><br><span class="line">  {</span><br><span class="line">    rhs.<span class="hljs-built_in">swap</span>(*<span class="hljs-keyword">this</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;</span><br><span class="line">  }</span><br><span class="line">  …</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>现在添加引用计数，形成shared_ptr:</p>
<figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utility&gt;</span>  <span class="hljs-comment">// std::swap</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">class</span> <span class="title class_">shared_count</span> {</span><br><span class="line"><span class="hljs-keyword">public</span>:</span><br><span class="line">  <span class="hljs-built_in">shared_count</span>() <span class="hljs-keyword">noexcept</span></span><br><span class="line">    : <span class="hljs-built_in">count_</span>(<span class="hljs-number">1</span>) {}</span><br><span class="line">  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">add_count</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span></span></span><br><span class="line"><span class="hljs-function">  </span>{</span><br><span class="line">    ++count_;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-type">long</span> <span class="hljs-title">reduce_count</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span></span></span><br><span class="line"><span class="hljs-function">  </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> --count_;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-type">long</span> <span class="hljs-title">get_count</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span></span></span><br><span class="line"><span class="hljs-function">  </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> count_;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">private</span>:</span><br><span class="line">  <span class="hljs-type">long</span> count_;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;</span><br><span class="line"><span class="hljs-keyword">class</span> <span class="title class_">smart_ptr</span> {</span><br><span class="line"><span class="hljs-keyword">public</span>:</span><br><span class="line">  <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> U&gt;</span><br><span class="line">  <span class="hljs-keyword">friend</span> <span class="hljs-keyword">class</span> <span class="title class_">smart_ptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">smart_ptr</span><span class="hljs-params">(T* ptr = <span class="hljs-literal">nullptr</span>)</span></span></span><br><span class="line"><span class="hljs-function">    : ptr_(ptr)</span></span><br><span class="line"><span class="hljs-function">  {</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (ptr) {</span><br><span class="line">      shared_count_ =</span><br><span class="line">        <span class="hljs-keyword">new</span> <span class="hljs-built_in">shared_count</span>();</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  ~<span class="hljs-built_in">smart_ptr</span>()</span><br><span class="line">  {</span><br><span class="line">    <span class="hljs-keyword">if</span> (ptr_ &amp;&amp;</span><br><span class="line">      !shared_count_</span><br><span class="line">         -&gt;<span class="hljs-built_in">reduce_count</span>()) {</span><br><span class="line">      <span class="hljs-keyword">delete</span> ptr_;</span><br><span class="line">      <span class="hljs-keyword">delete</span> shared_count_;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-built_in">smart_ptr</span>(<span class="hljs-type">const</span> smart_ptr&amp; other)</span><br><span class="line">  {</span><br><span class="line">    ptr_ = other.ptr_;</span><br><span class="line">    <span class="hljs-keyword">if</span> (ptr_) {</span><br><span class="line">      other.shared_count_</span><br><span class="line">        -&gt;<span class="hljs-built_in">add_count</span>();</span><br><span class="line">      shared_count_ =</span><br><span class="line">        other.shared_count_;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> U&gt;</span><br><span class="line">  <span class="hljs-built_in">smart_ptr</span>(<span class="hljs-type">const</span> smart_ptr&lt;U&gt;&amp; other) <span class="hljs-keyword">noexcept</span></span><br><span class="line">  {</span><br><span class="line">    ptr_ = other.ptr_;</span><br><span class="line">    <span class="hljs-keyword">if</span> (ptr_) {</span><br><span class="line">      other.shared_count_-&gt;<span class="hljs-built_in">add_count</span>();</span><br><span class="line">      shared_count_ = other.shared_count_;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> U&gt;</span><br><span class="line">  <span class="hljs-built_in">smart_ptr</span>(smart_ptr&lt;U&gt;&amp;&amp; other) <span class="hljs-keyword">noexcept</span></span><br><span class="line">  {</span><br><span class="line">    ptr_ = other.ptr_;</span><br><span class="line">    <span class="hljs-keyword">if</span> (ptr_) {</span><br><span class="line">      shared_count_ =</span><br><span class="line">        other.shared_count_;</span><br><span class="line">      other.ptr_ = <span class="hljs-literal">nullptr</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> U&gt;</span><br><span class="line">  <span class="hljs-built_in">smart_ptr</span>(<span class="hljs-type">const</span> smart_ptr&lt;U&gt;&amp; other,</span><br><span class="line">            T* ptr) <span class="hljs-keyword">noexcept</span></span><br><span class="line">  {</span><br><span class="line">    ptr_ = ptr;</span><br><span class="line">    <span class="hljs-keyword">if</span> (ptr_) {</span><br><span class="line">      other.shared_count_</span><br><span class="line">        -&gt;<span class="hljs-built_in">add_count</span>();</span><br><span class="line">      shared_count_ =</span><br><span class="line">        other.shared_count_;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  smart_ptr&amp;</span><br><span class="line">  <span class="hljs-keyword">operator</span>=(smart_ptr rhs) <span class="hljs-keyword">noexcept</span></span><br><span class="line">  {</span><br><span class="line">    rhs.<span class="hljs-built_in">swap</span>(*<span class="hljs-keyword">this</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function">T* <span class="hljs-title">get</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span></span></span><br><span class="line"><span class="hljs-function">  </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> ptr_;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-type">long</span> <span class="hljs-title">use_count</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span></span></span><br><span class="line"><span class="hljs-function">  </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (ptr_) {</span><br><span class="line">      <span class="hljs-keyword">return</span> shared_count_</span><br><span class="line">        -&gt;<span class="hljs-built_in">get_count</span>();</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">swap</span><span class="hljs-params">(smart_ptr&amp; rhs)</span> <span class="hljs-keyword">noexcept</span></span></span><br><span class="line"><span class="hljs-function">  </span>{</span><br><span class="line">    <span class="hljs-keyword">using</span> std::swap;</span><br><span class="line">    <span class="hljs-built_in">swap</span>(ptr_, rhs.ptr_);</span><br><span class="line">    <span class="hljs-built_in">swap</span>(shared_count_,</span><br><span class="line">         rhs.shared_count_);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  T&amp; <span class="hljs-keyword">operator</span>*() <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span></span><br><span class="line">  {</span><br><span class="line">    <span class="hljs-keyword">return</span> *ptr_;</span><br><span class="line">  }</span><br><span class="line">  T* <span class="hljs-keyword">operator</span>-&gt;() <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span></span><br><span class="line">  {</span><br><span class="line">    <span class="hljs-keyword">return</span> ptr_;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">operator</span> <span class="hljs-title">bool</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span></span></span><br><span class="line"><span class="hljs-function">  </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> ptr_;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">private</span>:</span><br><span class="line">  T* ptr_;</span><br><span class="line">  shared_count* shared_count_;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;</span><br><span class="line"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">swap</span><span class="hljs-params">(smart_ptr&lt;T&gt;&amp; lhs,</span></span></span><br><span class="line"><span class="hljs-params"><span class="hljs-function">          smart_ptr&lt;T&gt;&amp; rhs)</span> <span class="hljs-keyword">noexcept</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  lhs.<span class="hljs-built_in">swap</span>(rhs);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span> U&gt;</span><br><span class="line"><span class="hljs-function">smart_ptr&lt;T&gt; <span class="hljs-title">static_pointer_cast</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> smart_ptr&lt;U&gt;&amp; other)</span> <span class="hljs-keyword">noexcept</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  T* ptr = <span class="hljs-built_in">static_cast</span>&lt;T*&gt;(other.<span class="hljs-built_in">get</span>());</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-built_in">smart_ptr</span>&lt;T&gt;(other, ptr);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span> U&gt;</span><br><span class="line"><span class="hljs-function">smart_ptr&lt;T&gt; <span class="hljs-title">reinterpret_pointer_cast</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> smart_ptr&lt;U&gt;&amp; other)</span> <span class="hljs-keyword">noexcept</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  T* ptr = <span class="hljs-built_in">reinterpret_cast</span>&lt;T*&gt;(other.<span class="hljs-built_in">get</span>());</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-built_in">smart_ptr</span>&lt;T&gt;(other, ptr);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span> U&gt;</span><br><span class="line"><span class="hljs-function">smart_ptr&lt;T&gt; <span class="hljs-title">const_pointer_cast</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> smart_ptr&lt;U&gt;&amp; other)</span> <span class="hljs-keyword">noexcept</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  T* ptr = <span class="hljs-built_in">const_cast</span>&lt;T*&gt;(other.<span class="hljs-built_in">get</span>());</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-built_in">smart_ptr</span>&lt;T&gt;(other, ptr);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span> U&gt;</span><br><span class="line"><span class="hljs-function">smart_ptr&lt;T&gt; <span class="hljs-title">dynamic_pointer_cast</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> smart_ptr&lt;U&gt;&amp; other)</span> <span class="hljs-keyword">noexcept</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  T* ptr = <span class="hljs-built_in">dynamic_cast</span>&lt;T*&gt;(other.<span class="hljs-built_in">get</span>());</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-built_in">smart_ptr</span>&lt;T&gt;(other, ptr);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><img src="/2021/11/24/C-C%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/image-20220505200625623.png" alt="image-20220505200625623"></p>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><ul>
<li>shared_ptr怎么实现的<ul>
<li>见上</li>
</ul>
</li>
<li>shared_ptr是否线程安全<ul>
<li>分场景，同一个shared_ptr被多个线程写，不是线程安全的。多线程读是安全的，根据同一个智能指针创建新的智能指针（增加引用计数）也是安全的。（不懂）</li>
</ul>
</li>
</ul>
<h3 id="atomic"><a href="#atomic" class="headerlink" title="atomic"></a>atomic</h3><p>c++11引入atomic模板，可以应用到任何类型上，但实现不一样</p>
<p>对于整型量和指针等简单类型，通常结果是无锁的原子对象；</p>
<p>而对于另外一些类型，比如 64 位机器上大小不是 1、2、4、8（有些平台 / 编译器也支持对更大的数据进行无锁原子操作）的类型，编译器会自动为这些原子对象的操作加上锁。</p>
<p>编译器提供了一个原子对象的成员函数 is_lock_free，可以检查这个原子对象上的操作是否是无锁的。</p>
<h4 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h4><ul>
<li>atomic怎么实现的</li>
<li></li>
</ul>
<h3 id="std-function"><a href="#std-function" class="headerlink" title="std::function"></a>std::function</h3><p>std::function是一个可调用对象的包装器</p>
<p>可调用对象可以是：函数指针、一个有operator成员函数的类对象、可以被转换成函数指针的类对象、类成员函数指针。</p>
<p>比如：</p>
<figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 普通函数</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span></span>{<span class="hljs-keyword">return</span> a+b;} </span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// lambda表达式</span></span><br><span class="line"><span class="hljs-keyword">auto</span> mod = [](<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b){ <span class="hljs-keyword">return</span> a % b;}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 函数对象类</span></span><br><span class="line"><span class="hljs-keyword">struct</span> <span class="title class_">divide</span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">operator</span><span class="hljs-params">()</span><span class="hljs-params">(<span class="hljs-type">int</span> denominator, <span class="hljs-type">int</span> divisor)</span></span>{</span><br><span class="line">        <span class="hljs-keyword">return</span> denominator/divisor;</span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>虽然他们类型不同，但是调用形式是相同的，调用形式就是参数和返回值，也就是function初始化时候的模板参数，于是就可以这样写：</p>
<figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">std::function&lt;<span class="hljs-type">int</span>(<span class="hljs-type">int</span> ,<span class="hljs-type">int</span>)&gt;  a = add; </span><br><span class="line">std::function&lt;<span class="hljs-type">int</span>(<span class="hljs-type">int</span> ,<span class="hljs-type">int</span>)&gt;  b = mod ; </span><br><span class="line">std::function&lt;<span class="hljs-type">int</span>(<span class="hljs-type">int</span> ,<span class="hljs-type">int</span>)&gt;  c = <span class="hljs-built_in">divide</span>(); </span><br></pre></td></tr></tbody></table></figure>

<p>用来取代函数指针，特别适合作为回调函数使用。</p>
<h3 id="std-bind"><a href="#std-bind" class="headerlink" title="std::bind"></a>std::bind</h3><p>把可调用实体的某些传入参数，绑定到已有的变量，返回一个std::function</p>
<figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">struct</span> <span class="title class_">Foo</span> {</span><br><span class="line">    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_sum</span><span class="hljs-params">(<span class="hljs-type">int</span> n1, <span class="hljs-type">int</span> n2)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        std::cout &lt;&lt; n1+n2 &lt;&lt; <span class="hljs-string">'\n'</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-type">int</span> data = <span class="hljs-number">10</span>;</span><br><span class="line">};</span><br><span class="line"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">    Foo foo;</span><br><span class="line">    <span class="hljs-keyword">auto</span> f = std::<span class="hljs-built_in">bind</span>(&amp;Foo::print_sum, &amp;foo, <span class="hljs-number">95</span>, std::placeholders::_1);</span><br><span class="line">    <span class="hljs-built_in">f</span>(<span class="hljs-number">5</span>); <span class="hljs-comment">// 100</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>通过std::bind和std::function配合使用，所有的可调用对象均有了统一的操作方法。</p>
<h3 id="auto和decltype"><a href="#auto和decltype" class="headerlink" title="auto和decltype"></a>auto和decltype</h3><p>auto 的推导用在初始化时候，但目前的c++标准不允许类成员变量使用auto。</p>
<p>auto总是推导出值类型，不可能是引用。</p>
<p>auto可以加上const、volatile、*、&amp; 这样的类型修饰符，得到新的类型。</p>
<h2 id="STL"><a href="#STL" class="headerlink" title="STL"></a>STL</h2><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/difference-between-const-int-const-int-const-and-int-const/">const</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/37439983">static</a></li>
</ul>
</body></html>
        </div>
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2021/11/26/%E4%BF%A1%E5%8F%B7%E9%87%8F%E3%80%81%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%E3%80%81%E7%AE%A1%E7%A8%8B/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">信号量、条件变量、管程</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2021/11/19/fail2ban%E9%85%8D%E7%BD%AE/">
                <span class="level-item">fail2ban配置</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>


</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="/images/avatar.png" alt="JUSTME">
                    
                    
                    <p class="is-size-4 is-block">
                        JUSTME
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        UESTC
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>四川 成都</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        102
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        19
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        23
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/cccc1412" target="_blank">
                关注我</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Github" href="https://github.com/cccc1412">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Facebook" href="https://facebook.com">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Twitter" href="https://twitter.com">
                
                <i class="fab fa-twitter"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Dribbble" href="https://dribbble.com">
                
                <i class="fab fa-dribbble"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="RSS" href="/">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
<div class="card widget column-left is-sticky" id="toc">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                目录
            </h3>
            <ul class="menu-list"><li>
        <a class="is-flex" href="#Effective-c">
        <span class="has-mr-6">1</span>
        <span>Effective c++</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#item1-把c-看成语言的集合">
        <span class="has-mr-6">1.1</span>
        <span>item1 把c++看成语言的集合</span>
        </a></li><li>
        <a class="is-flex" href="#item2-用const、enum、inline代替-define">
        <span class="has-mr-6">1.2</span>
        <span>item2 用const、enum、inline代替#define</span>
        </a></li><li>
        <a class="is-flex" href="#item3-多用const">
        <span class="has-mr-6">1.3</span>
        <span>item3 多用const</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#const的使用范围">
        <span class="has-mr-6">1.3.1</span>
        <span>const的使用范围</span>
        </a></li><li>
        <a class="is-flex" href="#const的语法规则">
        <span class="has-mr-6">1.3.2</span>
        <span>const的语法规则</span>
        </a></li><li>
        <a class="is-flex" href="#STL迭代器的const">
        <span class="has-mr-6">1.3.3</span>
        <span>STL迭代器的const</span>
        </a></li><li>
        <a class="is-flex" href="#const在声明函数使用">
        <span class="has-mr-6">1.3.4</span>
        <span>const在声明函数使用</span>
        </a></li><li>
        <a class="is-flex" href="#const成员函数">
        <span class="has-mr-6">1.3.5</span>
        <span>const成员函数</span>
        </a></li><li>
        <a class="is-flex" href="#bitwise-constness和logical-constness">
        <span class="has-mr-6">1.3.6</span>
        <span>bitwise constness和logical constness</span>
        </a></li><li>
        <a class="is-flex" href="#const和non-const成员函数的重复问题">
        <span class="has-mr-6">1.3.7</span>
        <span>const和non-const成员函数的重复问题</span>
        </a></li><li>
        <a class="is-flex" href="#关于const约束的变量">
        <span class="has-mr-6">1.3.8</span>
        <span>关于const约束的变量</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#item-4确定对象被使用之前已经被初始化">
        <span class="has-mr-6">1.4</span>
        <span>item 4确定对象被使用之前已经被初始化</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#永远在对象使用之前初始化">
        <span class="has-mr-6">1.4.1</span>
        <span>永远在对象使用之前初始化</span>
        </a></li><li>
        <a class="is-flex" href="#赋值与初始化">
        <span class="has-mr-6">1.4.2</span>
        <span>赋值与初始化</span>
        </a></li></ul></li></ul></li><li>
        <a class="is-flex" href="#语法">
        <span class="has-mr-6">2</span>
        <span>语法</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#虚函数">
        <span class="has-mr-6">2.1</span>
        <span>虚函数</span>
        </a></li><li>
        <a class="is-flex" href="#static关键字">
        <span class="has-mr-6">2.2</span>
        <span>static关键字</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#静态成员变量">
        <span class="has-mr-6">2.2.1</span>
        <span>静态成员变量</span>
        </a></li><li>
        <a class="is-flex" href="#静态成员函数">
        <span class="has-mr-6">2.2.2</span>
        <span>静态成员函数</span>
        </a></li><li>
        <a class="is-flex" href="#静态全局变量">
        <span class="has-mr-6">2.2.3</span>
        <span>静态全局变量</span>
        </a></li><li>
        <a class="is-flex" href="#静态局部变量">
        <span class="has-mr-6">2.2.4</span>
        <span>静态局部变量</span>
        </a></li><li>
        <a class="is-flex" href="#静态函数">
        <span class="has-mr-6">2.2.5</span>
        <span>静态函数</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#RAII">
        <span class="has-mr-6">2.3</span>
        <span>RAII</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#modern-C">
        <span class="has-mr-6">3</span>
        <span>modern C++</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#完美转发std-forward">
        <span class="has-mr-6">3.1</span>
        <span>完美转发std::forward</span>
        </a></li><li>
        <a class="is-flex" href="#RAII和智能指针">
        <span class="has-mr-6">3.2</span>
        <span>RAII和智能指针</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#RAII-1">
        <span class="has-mr-6">3.2.1</span>
        <span>RAII</span>
        </a></li><li>
        <a class="is-flex" href="#智能指针实现">
        <span class="has-mr-6">3.2.2</span>
        <span>智能指针实现</span>
        </a></li><li>
        <a class="is-flex" href="#问题">
        <span class="has-mr-6">3.2.3</span>
        <span>问题</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#atomic">
        <span class="has-mr-6">3.3</span>
        <span>atomic</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#问题-1">
        <span class="has-mr-6">3.3.1</span>
        <span>问题</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#std-function">
        <span class="has-mr-6">3.4</span>
        <span>std::function</span>
        </a></li><li>
        <a class="is-flex" href="#std-bind">
        <span class="has-mr-6">3.5</span>
        <span>std::bind</span>
        </a></li><li>
        <a class="is-flex" href="#auto和decltype">
        <span class="has-mr-6">3.6</span>
        <span>auto和decltype</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#STL">
        <span class="has-mr-6">4</span>
        <span>STL</span>
        </a></li><li>
        <a class="is-flex" href="#参考">
        <span class="has-mr-6">5</span>
        <span>参考</span>
        </a></li></ul>
        </div>
    </div>
</div>

    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.svg" alt="C++/C语言学习" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2023 JUSTME&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>