<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8">
<title>Linux下的epoll和I/O复用 - JUSTME</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />



    <meta name="description" content="学libco过程中遇到了epoll和I&#x2F;O复用相关概念。">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux下的epoll和I&#x2F;O复用">
<meta property="og:url" content="http://yoursite.com/2021/01/11/Linux%E4%B8%8B%E7%9A%84epoll%E5%92%8CI-O%E5%A4%8D%E7%94%A8/index.html">
<meta property="og:site_name" content="JUSTME">
<meta property="og:description" content="学libco过程中遇到了epoll和I&#x2F;O复用相关概念。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/images/og_image.png">
<meta property="article:published_time" content="2021-01-11T09:00:58.000Z">
<meta property="article:modified_time" content="2023-05-18T08:34:48.995Z">
<meta property="article:author" content="JUSTME">
<meta property="article:tag" content="kernel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/images/og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/monokai-sublime.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
<meta name="generator" content="Hexo 5.4.2"></head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="Linux下的epoll和I/O复用" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">主页</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/categories">分类</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-01-11T09:00:58.000Z">2021-01-11</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    18 分钟 读完 (大约 2655 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-medium">
            
                Linux下的epoll和I/O复用
            
        </h1>
        <div class="content">
            <html><head></head><body><p>学libco过程中遇到了epoll和I/O复用相关概念。</p>
<span id="more"></span>

<h2 id="网络编程流程"><a href="#网络编程流程" class="headerlink" title="网络编程流程"></a>网络编程流程</h2><img src="/2021/01/11/Linux%E4%B8%8B%E7%9A%84epoll%E5%92%8CI-O%E5%A4%8D%E7%94%A8/image-20210429133738856.png" alt="image-20210429131500484" style="zoom:150%;">

<h2 id="阻塞IO和非阻塞IO"><a href="#阻塞IO和非阻塞IO" class="headerlink" title="阻塞IO和非阻塞IO"></a>阻塞IO和非阻塞IO</h2><p>每个连接都会对应一个读缓冲区和写缓冲区</p>
<p><img src="/2021/01/11/Linux%E4%B8%8B%E7%9A%84epoll%E5%92%8CI-O%E5%A4%8D%E7%94%A8/image-20210429131500484.png" alt="image-20210429131500484"></p>
<ul>
<li>阻塞在哪？<ul>
<li>阻塞在网络线程，比如调用了read/recv，下面的就不能运行，程序就卡在那里</li>
</ul>
</li>
<li>阻塞和非阻塞的差异？<ul>
<li>IO函数在数据到达时是否立刻返回，立刻返回的是非阻塞</li>
</ul>
</li>
<li>阻塞和非阻塞由什么决定？<ul>
<li>fd决定，默认fd是阻塞。</li>
<li>fcntl可以设置fd为非阻塞</li>
</ul>
</li>
</ul>
<h3 id="阻塞IO"><a href="#阻塞IO" class="headerlink" title="阻塞IO"></a>阻塞IO</h3><p><img src="/2021/01/11/Linux%E4%B8%8B%E7%9A%84epoll%E5%92%8CI-O%E5%A4%8D%E7%94%A8/%5CLinux%E4%B8%8B%E7%9A%84epoll%E5%92%8CI-O%E5%A4%8D%E7%94%A8%5Cimage-20210429130833394.png" alt="image-20210429130833394"></p>
<p>数据准备阶段是看readbuffer是否有数据，数据到达后把数据拷贝到用户空间，也就是应用程序中，这个是数据拷贝阶段。</p>
<h3 id="非阻塞IO"><a href="#非阻塞IO" class="headerlink" title="非阻塞IO"></a>非阻塞IO</h3><p><img src="/2021/01/11/Linux%E4%B8%8B%E7%9A%84epoll%E5%92%8CI-O%E5%A4%8D%E7%94%A8/image-20210429131711570.png" alt="image-20210429131711570"></p>
<p>假设当前readbuffer没有数据，调用read/recv会立马返回，继续执行read后面的逻辑</p>
<h3 id="阻塞非阻塞-同步和异步"><a href="#阻塞非阻塞-同步和异步" class="headerlink" title="阻塞非阻塞  同步和异步"></a>阻塞非阻塞  同步和异步</h3><p>阻塞和非阻塞强调的是线程的状态。</p>
<p>同步和异步强调的是执行顺序，同步可以确定程序执行的顺序调用，调用返回之前下一行代码不会调用。异步调用不明确执行顺序。</p>
<h2 id="I-O多路复用"><a href="#I-O多路复用" class="headerlink" title="I/O多路复用"></a>I/O多路复用</h2><blockquote>
<p>用一个线程检测多个IO事件，复用的是网络线程</p>
</blockquote>
<p>早期，为了实现一个服务器支持多个客户端的连接，使用fork/thread一个进程/线程的方式去接受并处理请求。这是阻塞IO+多线程，优点处理及时，但是线程利用率低，线程数有限。</p>
<p>一个连接到来后，遍历所有的已注册的文件描述符，找到需要处理的文件描述符，也就是select和poll。</p>
<p><img src="/2021/01/11/Linux%E4%B8%8B%E7%9A%84epoll%E5%92%8CI-O%E5%A4%8D%E7%94%A8/image-20210429132812772.png" alt="image-20210429132812772"></p>
<p><strong>IO多路复用作用在数据准备阶段</strong></p>
<p>由于遍历引起的巨大开销O(n)，在原有的基础上进一步优化，有了epoll的方法。</p>
<p>epoll</p>
<blockquote>
<p><code>epoll</code>是linux内核的可扩展I/O事件通知机制。</p>
</blockquote>
<p>使用一个文件描述符管理多个描述符。</p>
<h2 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h2><blockquote>
<p>epoll 全程 event poll 事件轮询</p>
</blockquote>
<p>epoll实际是从操作系统订阅消息。</p>
<p>epoll将进程关注的文件描述符存入一颗红黑树，在这棵红黑树中，key是socket的编号，值是socket关注的消息。当内核发生了一个事件的时候，比如socket编号1000可以读取，这个时候就从红黑树查找进程是否关注了这个事件。</p>
<p>为什么用红黑树：内核可以快速判断某个消息是否需要发送给使用epoll的线程。</p>
<p>当关注的事件发生时，epoll会将这个fd放到一个就绪队列中，当用户调用epoll_wait的时候，就会从队列中返回一个消息。epoll_wait不一定立刻返回，可以设置timeout，如果设置成0就立刻返回，epoll就是非阻塞的。</p>
<h3 id="程序接口"><a href="#程序接口" class="headerlink" title="程序接口"></a>程序接口</h3><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">epoll_create</span><span class="hljs-params">(<span class="hljs-type">int</span> size)</span></span>;</span><br></pre></td></tr></tbody></table></figure>

<p>在内核中创建epoll实例，并返回一个epoll文件描述符。size是要监听的文件描述符数量，大于size的话内核会自动扩容。</p>
<figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">epoll_ctl</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-type">int</span> op, <span class="hljs-type">int</span> fd, <span class="hljs-keyword">struct</span> epoll_event *event)</span></span>;<span class="hljs-comment">//ctl就是control</span></span><br></pre></td></tr></tbody></table></figure>

<p>向epfd对应的内核epoll实例添加、修改或删除对fd事件event的监听。</p>
<p>op 为 </p>
<ul>
<li><p><code>EPOLL_CTL_ADD</code>：往事件表中注册fd上的事件</p>
</li>
<li><p><code>EPOLL_CTL_MOD</code>：修改fd上的注册事件</p>
</li>
<li><p><code>EPOLL_CTL_DEL</code> ：删除fd上的注册事件</p>
</li>
</ul>
<p>如果 event 的 events 属性设置了 <code>EPOLLET</code> flag，那么监听该事件的方式是边缘触发。</p>
<figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">epoll_wait</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-keyword">struct</span> epoll_event *events, <span class="hljs-type">int</span> maxevents, <span class="hljs-type">int</span> timeout)</span></span>;</span><br></pre></td></tr></tbody></table></figure>

<p>当 timeout 为 0 时，epoll_wait 立即返回。</p>
<p> timeout 为 -1 时，epoll_wait 会阻塞直到已注册的事件变为就绪。</p>
<p>当 timeout 为一正整数时，epoll 会阻塞直到计时 timeout 毫秒或已注册的事件变为就绪。（因为内核调度延迟，阻塞会略微超过 timeout 毫秒）。</p>
<h3 id="epoll的实现"><a href="#epoll的实现" class="headerlink" title="epoll的实现"></a>epoll的实现</h3><h4 id="重要数据结构"><a href="#重要数据结构" class="headerlink" title="重要数据结构"></a>重要数据结构</h4><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">struct</span> <span class="title class_">eventpoll</span> {</span><br><span class="line">    <span class="hljs-keyword">struct</span> <span class="title class_">rb_root</span> rbr; <span class="hljs-comment">//红黑树,管理epoll监听的事件</span></span><br><span class="line">    <span class="hljs-keyword">struct</span> <span class="title class_">list_head</span> rdlist;<span class="hljs-comment">//保存epoll_wait 返回满足条件的时间</span></span><br><span class="line">    ...</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">struct</span> <span class="title class_">epoll_event</span> {</span><br><span class="line">    <span class="hljs-type">__uint32_t</span> events; <span class="hljs-comment">/* Epoll events */</span></span><br><span class="line">    <span class="hljs-type">epoll_data_t</span> data; <span class="hljs-comment">/* User data variable */</span></span><br><span class="line">};</span><br><span class="line">events可以是以下几个宏的集合：</span><br><span class="line">EPOLLIN ：表示对应的文件描述符可以读（包括对端SOCKET正常关闭）；</span><br><span class="line">EPOLLOUT：表示对应的文件描述符可以写；</span><br><span class="line">EPOLLPRI：表示对应的文件描述符有紧急的数据可读（这里应该表示有带外数据到来）；</span><br><span class="line">EPOLLERR：表示对应的文件描述符发生错误；</span><br><span class="line">EPOLLHUP：表示对应的文件描述符被挂断；</span><br><span class="line">EPOLLET： 将EPOLL设为边缘触发(Edge Triggered)模式，这是相对于水平触发(Level Triggered)来说的。</span><br><span class="line">EPOLLONESHOT：只监听一次事件，当监听完这次事件之后，如果还需要继续监听这个socket的话，需要再次把这个socket加入到EPOLL队列里</span><br></pre></td></tr></tbody></table></figure>

<p>描述监控事件，<code>events</code>对应文件描述符事件</p>
<p><code>epoll_data_t</code>是一个联合体，同一时间只能使用一个字段</p>
<figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">union</span> <span class="title class_">epoll_data</span> {</span><br><span class="line">    <span class="hljs-type">void</span> *ptr;</span><br><span class="line">    <span class="hljs-type">int</span> fd;</span><br><span class="line">    <span class="hljs-type">__uint32_t</span> u32;</span><br><span class="line">    <span class="hljs-type">__uint64_t</span> u64;</span><br><span class="line">} <span class="hljs-type">epoll_data_t</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>事件发生时，用户设置的data字段将会返回给使用者</p>
<h3 id="原理图"><a href="#原理图" class="headerlink" title="原理图"></a>原理图</h3><p><img src="/2021/01/11/Linux%E4%B8%8B%E7%9A%84epoll%E5%92%8CI-O%E5%A4%8D%E7%94%A8/image-20210429133121513.png" alt="image-20210429133121513"></p>
<h4 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h4><p><code>mmap</code>将用户空间的一块地址和内核空间的一块地址同时映射到相同的一块物理内存地址，这块物理内存对内核和用户均可见，内核可以直接看到epoll监听的句柄。</p>
<h4 id="红黑树"><a href="#红黑树" class="headerlink" title="红黑树"></a>红黑树</h4><blockquote>
<p>二叉搜索树</p>
</blockquote>
<p>存储epoll监听的套接字fd。存储到mmap出来的内存。添加或者删除一个套接字（<code>epoll_ctl</code>）时，都在红黑树上去处理。</p>
<p>通过<code>epoll_ctl</code> 添加进来的fd都会放在红黑树的节点内。</p>
<p>同时与网卡驱动建立回调关系，如果网卡驱动检测到节点有事件，节点会被拷贝到就绪队列</p>
<h4 id="双向链表"><a href="#双向链表" class="headerlink" title="双向链表"></a>双向链表</h4><p>先看epoll_wait做了什么：</p>
<ul>
<li><p>调用ep_poll，当双向链表中无就绪fd，挂起当前进程，直到链表不为空。</p>
</li>
<li><p>当文件fd状态改变，不可读/不可写变为可读/可写，对应fd上的回调函数ep_poll_callback会被调用</p>
</li>
<li><p>ep_poll_callback将相应fd对应的epitem加入链表，导致链表不为空，进程被唤醒，epoll_wait继续执行。</p>
</li>
<li><p>ep_event_transfer函数将rdlist中的epitem拷贝到txlist,rdlist清空</p>
</li>
<li><p>ep_send_event，扫描txlist中的每个epitem，调用关联fd对应的poll方法，从而获得fd上较新的events，封装在epoll_event从epoll_wait返回。</p>
</li>
</ul>
<h3 id="epoll使用"><a href="#epoll使用" class="headerlink" title="epoll使用"></a>epoll使用</h3><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-type">int</span> listenfd = socket;</span><br><span class="line"><span class="hljs-built_in">bind</span>(listenfd,addr);</span><br><span class="line"><span class="hljs-built_in">listen</span>(listenfd);</span><br><span class="line"><span class="hljs-type">int</span> efd = <span class="hljs-built_in">epoll_create</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">//创建根节点</span></span><br><span class="line"><span class="hljs-built_in">epoll_ctl</span>(efd,epoll_ctl_add,listenfd,&amp;ev);<span class="hljs-comment">//把fd放到红黑树</span></span><br><span class="line"><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {</span><br><span class="line">    epoll_event ev[size];<span class="hljs-comment">//需要在用户态分配内存</span></span><br><span class="line">    <span class="hljs-type">int</span> nevent = <span class="hljs-built_in">epoll_wait</span>(efd,ev,size,timeout);<span class="hljs-comment">//作用在数据准备阶段</span></span><br><span class="line">    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; nevent; i++) {</span><br><span class="line">		epoll_event *e = ev[i];</span><br><span class="line">        <span class="hljs-keyword">if</span>(e-&gt;fd == listenfd) {</span><br><span class="line">			<span class="hljs-type">int</span> clientfd = <span class="hljs-built_in">accept</span>(listenfd);</span><br><span class="line">            <span class="hljs-built_in">epoll_ctl</span>(efd,epoll_ctl,clientfd.&amp;env);</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-keyword">if</span> (读事件) {</span><br><span class="line">                <span class="hljs-built_in">read</span>();</span><br><span class="line">                logic;</span><br><span class="line">                <span class="hljs-built_in">send</span>();</span><br><span class="line">            }</span><br><span class="line">            <span class="hljs-keyword">if</span> (写事件) <span class="hljs-built_in">send</span>();</span><br><span class="line">            <span class="hljs-keyword">if</span> (错误事件) <span class="hljs-built_in">close</span>();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="epoll的ET与LT"><a href="#epoll的ET与LT" class="headerlink" title="epoll的ET与LT"></a>epoll的ET与LT</h3><blockquote>
<p>ET：边沿触发  LT:水平触发</p>
</blockquote>
<h4 id="LT水平"><a href="#LT水平" class="headerlink" title="LT水平"></a>LT水平</h4><p><strong>EPOLLIN</strong>的触发条件是 *<em>读缓冲区非空 *</em></p>
<p><strong>EPOLLOUT</strong>的触发条件是 *<em>写缓冲区非满 *</em></p>
<h4 id="ET边沿"><a href="#ET边沿" class="headerlink" title="ET边沿"></a>ET边沿</h4><p><strong>EPOLLIN</strong>的触发条件：对端有数据写入才会触发，所以触发一次要不断读数据直到所有的数据都读完，否则只能登下次对端写入了。所以epoll必须要求异步socket。</p>
<p><strong>EPOLLOUT</strong>的触发：连接时触发一次，表示可写。</p>
<p>​    或者某次write，写满了发送缓冲区，对端读了一些数据，又重新可写了</p>
<p>​    也就是说EPOLLOUT发生在不写到可写转化的时刻。</p>
<p>​    如果想人为的强制触发，使用epoll_ctl重新设置event就可以，会马上触发一次EPOLLOUT事件。</p>
<h2 id="reactor"><a href="#reactor" class="headerlink" title="reactor"></a>reactor</h2><blockquote>
<p>组成：非阻塞IO+IO多路复用</p>
<p>特征：基于事件循环，以事件驱动或者事件回调来实现业务逻辑</p>
<p><strong>Reactor：</strong> 即非阻塞同步网络模型，可以理解为，向内核去注册一个感兴趣的事件，事件来了去通知你，你去处理</p>
<p> <strong>Proactor：</strong> 即异步网络模型，可以理解为，向内核去注册一个感兴趣的事件及其处理handler，事件来了，内核去处理，完成之后告诉你</p>
</blockquote>
<p>reactor要求主线程（I/O处理单元）只负责监听文件描述符上是否有事件发生，有的话就通知工作线程（逻辑单元），读写数据，接受新的连接，处理客户请求均在工作线程中完成。</p>
<p>使用同步I/O模型实现的reactor模式的工作流程为：</p>
<ul>
<li>主线程向epoll内核事件表中注册socket上的读就绪事件</li>
<li>主线程调用epoll_wait等待socket上有数据可读</li>
<li>当socket上有数据到达，epoll_wait通知主线程，主线程将socket可读事件放入请求队列</li>
<li>睡眠在请求队列上的某个工作线程被唤醒。这个工作线程从socket上读取数据，并处理客户请求，然后往epoll内核事件表中注册该socket上的写就绪事件。</li>
<li>主线程调用epoll_wait等待socket可写。</li>
<li>socket可写时，epoll_wait通知主线程，主线程将socket的可写事件放入请求队列</li>
<li>睡眠在请求队列上的某个工作线程被唤醒，向客户发送服务器的处理结果。</li>
</ul>
<p><img src="/2021/01/11/Linux%E4%B8%8B%E7%9A%84epoll%E5%92%8CI-O%E5%A4%8D%E7%94%A8/image-20211130215419386.png" alt="image-20211130215419386"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/shine-yr/p/5214705.html">https://www.cnblogs.com/shine-yr/p/5214705.html</a></p>
</body></html>
        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link-link" href="/tags/kernel/" rel="tag">kernel</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2021/01/21/UNIX%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B-%E7%AC%AC%E4%B8%89%E7%AB%A0%E6%96%87%E4%BB%B6IO/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">UNIX环境高级编程-第三章文件IO</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2021/01/09/gdb%E5%AD%A6%E4%B9%A0/">
                <span class="level-item">gdb学习</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>


</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="/images/avatar.png" alt="JUSTME">
                    
                    
                    <p class="is-size-4 is-block">
                        JUSTME
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        UESTC
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>四川 成都</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        102
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        19
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        23
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/cccc1412" target="_blank">
                关注我</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Github" href="https://github.com/cccc1412">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Facebook" href="https://facebook.com">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Twitter" href="https://twitter.com">
                
                <i class="fab fa-twitter"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Dribbble" href="https://dribbble.com">
                
                <i class="fab fa-dribbble"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="RSS" href="/">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
<div class="card widget column-left is-sticky" id="toc">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                目录
            </h3>
            <ul class="menu-list"><li>
        <a class="is-flex" href="#网络编程流程">
        <span class="has-mr-6">1</span>
        <span>网络编程流程</span>
        </a></li><li>
        <a class="is-flex" href="#阻塞IO和非阻塞IO">
        <span class="has-mr-6">2</span>
        <span>阻塞IO和非阻塞IO</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#阻塞IO">
        <span class="has-mr-6">2.1</span>
        <span>阻塞IO</span>
        </a></li><li>
        <a class="is-flex" href="#非阻塞IO">
        <span class="has-mr-6">2.2</span>
        <span>非阻塞IO</span>
        </a></li><li>
        <a class="is-flex" href="#阻塞非阻塞-同步和异步">
        <span class="has-mr-6">2.3</span>
        <span>阻塞非阻塞  同步和异步</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#I-O多路复用">
        <span class="has-mr-6">3</span>
        <span>I/O多路复用</span>
        </a></li><li>
        <a class="is-flex" href="#epoll">
        <span class="has-mr-6">4</span>
        <span>epoll</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#程序接口">
        <span class="has-mr-6">4.1</span>
        <span>程序接口</span>
        </a></li><li>
        <a class="is-flex" href="#epoll的实现">
        <span class="has-mr-6">4.2</span>
        <span>epoll的实现</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#重要数据结构">
        <span class="has-mr-6">4.2.1</span>
        <span>重要数据结构</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#原理图">
        <span class="has-mr-6">4.3</span>
        <span>原理图</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#mmap">
        <span class="has-mr-6">4.3.1</span>
        <span>mmap</span>
        </a></li><li>
        <a class="is-flex" href="#红黑树">
        <span class="has-mr-6">4.3.2</span>
        <span>红黑树</span>
        </a></li><li>
        <a class="is-flex" href="#双向链表">
        <span class="has-mr-6">4.3.3</span>
        <span>双向链表</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#epoll使用">
        <span class="has-mr-6">4.4</span>
        <span>epoll使用</span>
        </a></li><li>
        <a class="is-flex" href="#epoll的ET与LT">
        <span class="has-mr-6">4.5</span>
        <span>epoll的ET与LT</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#LT水平">
        <span class="has-mr-6">4.5.1</span>
        <span>LT水平</span>
        </a></li><li>
        <a class="is-flex" href="#ET边沿">
        <span class="has-mr-6">4.5.2</span>
        <span>ET边沿</span>
        </a></li></ul></li></ul></li><li>
        <a class="is-flex" href="#reactor">
        <span class="has-mr-6">5</span>
        <span>reactor</span>
        </a></li><li>
        <a class="is-flex" href="#参考">
        <span class="has-mr-6">6</span>
        <span>参考</span>
        </a></li></ul>
        </div>
    </div>
</div>

    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.svg" alt="Linux下的epoll和I/O复用" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2023 JUSTME&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>