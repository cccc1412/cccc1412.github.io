<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8">
<title>对象池与operator重载 - JUSTME</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />



    <meta name="description" content="对象池与operator重载">
<meta property="og:type" content="article">
<meta property="og:title" content="对象池与operator重载">
<meta property="og:url" content="http://yoursite.com/2022/07/19/%E5%AF%B9%E8%B1%A1%E6%B1%A0%E4%B8%8Eoperator%E9%87%8D%E8%BD%BD/index.html">
<meta property="og:site_name" content="JUSTME">
<meta property="og:description" content="对象池与operator重载">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/images/og_image.png">
<meta property="article:published_time" content="2022-07-19T05:54:02.000Z">
<meta property="article:modified_time" content="2023-05-18T08:34:49.439Z">
<meta property="article:author" content="JUSTME">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/images/og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/monokai-sublime.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
<meta name="generator" content="Hexo 5.4.2"></head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="对象池与operator重载" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">主页</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/categories">分类</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2022-07-19T05:54:02.000Z">2022-07-19</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 分钟 读完 (大约 1103 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-medium">
            
                对象池与operator重载
            
        </h1>
        <div class="content">
            <html><head></head><body><p>对象池与operator重载</p>
<span id="more"></span>
<h2 id="new作为关键字和运算符"><a href="#new作为关键字和运算符" class="headerlink" title="new作为关键字和运算符"></a>new作为关键字和运算符</h2><p><code>operator new can be called explicitly as a regular function, but in C++, new is an operator with a very specific behavior: An expression with the new operator, first calls function operator new (i.e., this function) with the size of its type specifier as first argument, and if this is successful, it then automatically initializes or constructs the object (if needed). Finally, the expression evaluates as a pointer to the appropriate type.</code></p>
<p>代码里写的new是关键字，编译器根据实际情况调用new运算符。</p>
<p>代码里写下new关键字，编译器会：<br>1、调用operator new，也就是调用new运算符malloc，返回ptr。new运算符可以用户重载。<br>2、调用A::A()构造函数在ptr上初始化对象。<br>3、void*类型转化，返回对象的指针。</p>
<h2 id="placement-new"><a href="#placement-new" class="headerlink" title="placement new"></a>placement new</h2><figure class="highlight plaintext hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A* p = new(ptr) A()</span><br></pre></td></tr></tbody></table></figure>
<p>placement new也是new运算符的重载，多传入了一个参数<code>void* ptr</code>，定义在<code>#incldue&lt;new&gt;</code>中，对步骤一来说，直接返回ptr, 不再分配内存（用户已经分配好了，传入ptr）。</p>
<h2 id="对象池"><a href="#对象池" class="headerlink" title="对象池"></a>对象池</h2><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _ObjectPoolBase_hpp_</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _ObjectPoolBase_hpp_</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _DEBUG</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> xPrintf</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">define</span> xPrintf(...) printf(__VA_ARGS__)</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">else</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> xPrintf</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">define</span> xPrintf(...)</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// _DEBUG</span></span></span><br><span class="line"><span class="hljs-comment">//模板给对象池提供参数接口</span></span><br><span class="line"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> <span class="title class_">Type</span>, <span class="hljs-type">size_t</span> nPoolSzie&gt;</span><br><span class="line"><span class="hljs-comment">//对象池的实现</span></span><br><span class="line"><span class="hljs-keyword">class</span> <span class="title class_">CELLObjectPool</span></span><br><span class="line">{</span><br><span class="line"><span class="hljs-keyword">public</span>:</span><br><span class="line">    <span class="hljs-built_in">CELLObjectPool</span>()</span><br><span class="line">    {</span><br><span class="line">        <span class="hljs-built_in">initPool</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ~<span class="hljs-built_in">CELLObjectPool</span>()</span><br><span class="line">    {</span><br><span class="line">        <span class="hljs-keyword">if</span> (_pBuf)</span><br><span class="line">            <span class="hljs-keyword">delete</span>[] _pBuf;</span><br><span class="line">    }</span><br><span class="line"><span class="hljs-keyword">private</span>:</span><br><span class="line">    <span class="hljs-comment">//NodeHeader是每个对象的描述信息</span></span><br><span class="line">    <span class="hljs-keyword">class</span> <span class="title class_">NodeHeader</span></span><br><span class="line">    {</span><br><span class="line">    <span class="hljs-keyword">public</span>:</span><br><span class="line">        <span class="hljs-comment">//下一块位置</span></span><br><span class="line">        NodeHeader* pNext;</span><br><span class="line">        <span class="hljs-comment">//内存块编号</span></span><br><span class="line">        <span class="hljs-type">int</span> nID;</span><br><span class="line">        <span class="hljs-comment">//引用次数</span></span><br><span class="line">        <span class="hljs-type">char</span> nRef;</span><br><span class="line">        <span class="hljs-comment">//是否在内存池中</span></span><br><span class="line">        <span class="hljs-type">bool</span> bPool;</span><br><span class="line">    <span class="hljs-keyword">private</span>:</span><br><span class="line">        <span class="hljs-comment">//预留</span></span><br><span class="line">        <span class="hljs-type">char</span> c1;</span><br><span class="line">        <span class="hljs-type">char</span> c2;</span><br><span class="line">    };</span><br><span class="line"><span class="hljs-keyword">public</span>:</span><br><span class="line">    <span class="hljs-comment">//释放对象内存</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">freeObjMemory</span><span class="hljs-params">(<span class="hljs-type">void</span>* pMem)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-comment">//首地址往前偏移，对象和对象描述信息的内存一起释放</span></span><br><span class="line">        NodeHeader* pBlock = (NodeHeader*)((<span class="hljs-type">char</span>*)pMem - <span class="hljs-built_in">sizeof</span>(NodeHeader));</span><br><span class="line">        <span class="hljs-built_in">xPrintf</span>(<span class="hljs-string">"freeObjMemory: %llx, id=%d\n"</span>, pBlock, pBlock-&gt;nID);</span><br><span class="line">        <span class="hljs-built_in">assert</span>(<span class="hljs-number">1</span> == pBlock-&gt;nRef);</span><br><span class="line">        <span class="hljs-comment">//内存在对象池的部分释放之后，指针回到第一个未分配的对象</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (pBlock-&gt;bPool)</span><br><span class="line">        {</span><br><span class="line">            <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lg</span><span class="hljs-params">(_mutex)</span></span>;</span><br><span class="line">            <span class="hljs-keyword">if</span> (--pBlock-&gt;nRef != <span class="hljs-number">0</span>)</span><br><span class="line">            {</span><br><span class="line">                <span class="hljs-keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            pBlock-&gt;pNext = _pHeader;</span><br><span class="line">            _pHeader = pBlock;</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-keyword">if</span> (--pBlock-&gt;nRef != <span class="hljs-number">0</span>)</span><br><span class="line">            {</span><br><span class="line">                <span class="hljs-keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="hljs-comment">//不在对象池的直接释放内存</span></span><br><span class="line">            <span class="hljs-keyword">delete</span>[] pBlock;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-comment">//申请对象内存，优先向内存池申请内存，内存池不够在向系统申请内存</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">allocObjMemory</span><span class="hljs-params">(<span class="hljs-type">size_t</span> nSize)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lg</span><span class="hljs-params">(_mutex)</span></span>;</span><br><span class="line">        NodeHeader* pReturn = <span class="hljs-literal">nullptr</span>;</span><br><span class="line">        <span class="hljs-comment">//如果对象池已经满了，数量达到上限，需要向系统申请内存</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-literal">nullptr</span> == _pHeader)</span><br><span class="line">        {</span><br><span class="line">            <span class="hljs-comment">//计算对象池大小=对象数量*（一个对象内存大小+对象描述信息内存大小）</span></span><br><span class="line">            pReturn = (NodeHeader*)<span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[<span class="hljs-built_in">sizeof</span>(Type) + <span class="hljs-built_in">sizeof</span>(NodeHeader)];</span><br><span class="line">            pReturn-&gt;bPool = <span class="hljs-literal">false</span>;</span><br><span class="line">            pReturn-&gt;nID = <span class="hljs-number">-1</span>;</span><br><span class="line">            pReturn-&gt;nRef = <span class="hljs-number">1</span>;</span><br><span class="line">            pReturn-&gt;pNext = <span class="hljs-literal">nullptr</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">else</span> {</span><br><span class="line">            pReturn = _pHeader;</span><br><span class="line">            _pHeader = _pHeader-&gt;pNext;</span><br><span class="line">            <span class="hljs-built_in">assert</span>(<span class="hljs-number">0</span> == pReturn-&gt;nRef);</span><br><span class="line">            pReturn-&gt;nRef = <span class="hljs-number">1</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-built_in">xPrintf</span>(<span class="hljs-string">"allocObjMemory: %llx, id=%d, size=%d\n"</span>, pReturn, pReturn-&gt;nID, nSize);</span><br><span class="line">        <span class="hljs-keyword">return</span> ((<span class="hljs-type">char</span>*)pReturn + <span class="hljs-built_in">sizeof</span>(NodeHeader));</span><br><span class="line">    }</span><br><span class="line"><span class="hljs-keyword">private</span>:</span><br><span class="line">    <span class="hljs-comment">//初始化对象池</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">initPool</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-comment">//断言</span></span><br><span class="line">        <span class="hljs-built_in">assert</span>(<span class="hljs-literal">nullptr</span> == _pBuf);</span><br><span class="line">        <span class="hljs-comment">//对象池不为空（已经初始化过），不初始化直接返回</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (_pBuf)</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line">        <span class="hljs-comment">//计算对象池大小=对象数量*（一个对象内存大小+对象描述信息内存大小）</span></span><br><span class="line">        <span class="hljs-type">size_t</span> realSzie = <span class="hljs-built_in">sizeof</span>(Type) + <span class="hljs-built_in">sizeof</span>(NodeHeader);</span><br><span class="line">        <span class="hljs-type">size_t</span> n = nPoolSzie * realSzie;</span><br><span class="line">        <span class="hljs-comment">//申请池的内存</span></span><br><span class="line">        _pBuf = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[n];</span><br><span class="line">        <span class="hljs-comment">//初始化内存池</span></span><br><span class="line">        _pHeader = (NodeHeader*)_pBuf;</span><br><span class="line">        _pHeader-&gt;bPool = <span class="hljs-literal">true</span>;</span><br><span class="line">        _pHeader-&gt;nID = <span class="hljs-number">0</span>;</span><br><span class="line">        _pHeader-&gt;nRef = <span class="hljs-number">0</span>;</span><br><span class="line">        _pHeader-&gt;pNext = <span class="hljs-literal">nullptr</span>;</span><br><span class="line">        <span class="hljs-comment">//遍历内存块进行初始化</span></span><br><span class="line">        NodeHeader* pTemp1 = _pHeader;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> n = <span class="hljs-number">1</span>; n &lt; nPoolSzie; n++)</span><br><span class="line">        {</span><br><span class="line">            NodeHeader* pTemp2 = (NodeHeader*)(_pBuf + (n* realSzie));</span><br><span class="line">            pTemp2-&gt;bPool = <span class="hljs-literal">true</span>;</span><br><span class="line">            pTemp2-&gt;nID = n;</span><br><span class="line">            pTemp2-&gt;nRef = <span class="hljs-number">0</span>;</span><br><span class="line">            pTemp2-&gt;pNext = <span class="hljs-literal">nullptr</span>;</span><br><span class="line">            pTemp1-&gt;pNext = pTemp2;</span><br><span class="line">            pTemp1 = pTemp2;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"><span class="hljs-keyword">private</span>:</span><br><span class="line">    <span class="hljs-comment">//描述信息块地址</span></span><br><span class="line">    NodeHeader* _pHeader;</span><br><span class="line">    <span class="hljs-comment">//对象池内存缓存区地址</span></span><br><span class="line">    <span class="hljs-type">char</span>* _pBuf;</span><br><span class="line">    <span class="hljs-comment">//多线程使用需要加锁</span></span><br><span class="line">    std::mutex _mutex;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//模板类给主函数使用对象池提供接口</span></span><br><span class="line"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> <span class="title class_">Type</span>, <span class="hljs-type">size_t</span> nPoolSzie&gt;</span><br><span class="line"><span class="hljs-comment">//使用对象池的类</span></span><br><span class="line"><span class="hljs-keyword">class</span> <span class="title class_">ObjectPoolBase</span></span><br><span class="line">{</span><br><span class="line"><span class="hljs-keyword">public</span>:</span><br><span class="line">    <span class="hljs-comment">//重载给对象申请内存的new操作</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> nSize)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-built_in">objectPool</span>().<span class="hljs-built_in">allocObjMemory</span>(nSize);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-comment">//重载给对象释放内存的delete操作</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span>* p)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-built_in">objectPool</span>().<span class="hljs-built_in">freeObjMemory</span>(p);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-comment">//</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ...Args&gt;</span></span><br><span class="line"><span class="hljs-function">    <span class="hljs-type">static</span> Type* <span class="hljs-title">createObject</span><span class="hljs-params">(Args ... args)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{   <span class="hljs-comment">//不定参数  可变参数</span></span><br><span class="line">        Type* obj = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Type</span>(args...);</span><br><span class="line">        <span class="hljs-comment">//可以做点其它的事情，比如说对象的放逐和驱逐</span></span><br><span class="line">        <span class="hljs-keyword">return</span> obj;</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-comment">//销毁对象</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">destroyObject</span><span class="hljs-params">(Type* obj)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">delete</span> obj;</span><br><span class="line">    }</span><br><span class="line"><span class="hljs-keyword">private</span>:</span><br><span class="line">    <span class="hljs-comment">//定义不同类型的对象池</span></span><br><span class="line">    <span class="hljs-keyword">typedef</span> CELLObjectPool&lt;Type, nPoolSzie&gt; ClassTypePool;</span><br><span class="line">    <span class="hljs-comment">//单例-饿汉模式，实例化一个对象池</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-type">static</span> ClassTypePool&amp; <span class="hljs-title">objectPool</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{   <span class="hljs-comment">//静态CELLObjectPool对象</span></span><br><span class="line">        <span class="hljs-type">static</span> ClassTypePool sPool;</span><br><span class="line">        <span class="hljs-keyword">return</span> sPool;</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// !_ObjectPoolBase_hpp_</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ObjectPoolBase.hpp"</span></span></span><br></pre></td></tr></tbody></table></figure>
<p>这样也就能理解为什么从对象池中分配调用的是：<code>Type* obj = new Type(args...)</code><br>而new的重载只有一个参数<code>nSize</code>，因为<code>nSize</code>就是new运算符的默认参数，分配了内存后再调用构造函数<code>Type(args...)</code>初始化。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>new: <a target="_blank" rel="noopener" href="https://blog.csdn.net/ly930156123/article/details/78855379">https://blog.csdn.net/ly930156123/article/details/78855379</a><br>对象池实现：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/-citywall123/p/12726552.html">https://www.cnblogs.com/-citywall123/p/12726552.html</a></p>
</body></html>
        </div>
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2023/02/27/oceanbase-2022-%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%9B%98/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">oceanbase 2022 比赛复盘</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2022/07/14/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">
                <span class="level-item">性能分析</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>


</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="/images/avatar.png" alt="JUSTME">
                    
                    
                    <p class="is-size-4 is-block">
                        JUSTME
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        UESTC
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>四川 成都</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        102
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        19
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        23
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/cccc1412" target="_blank">
                关注我</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Github" href="https://github.com/cccc1412">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Facebook" href="https://facebook.com">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Twitter" href="https://twitter.com">
                
                <i class="fab fa-twitter"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Dribbble" href="https://dribbble.com">
                
                <i class="fab fa-dribbble"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="RSS" href="/">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
<div class="card widget column-left is-sticky" id="toc">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                目录
            </h3>
            <ul class="menu-list"><li>
        <a class="is-flex" href="#new作为关键字和运算符">
        <span class="has-mr-6">1</span>
        <span>new作为关键字和运算符</span>
        </a></li><li>
        <a class="is-flex" href="#placement-new">
        <span class="has-mr-6">2</span>
        <span>placement new</span>
        </a></li><li>
        <a class="is-flex" href="#对象池">
        <span class="has-mr-6">3</span>
        <span>对象池</span>
        </a></li><li>
        <a class="is-flex" href="#参考">
        <span class="has-mr-6">4</span>
        <span>参考</span>
        </a></li></ul>
        </div>
    </div>
</div>

    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.svg" alt="对象池与operator重载" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2023 JUSTME&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>